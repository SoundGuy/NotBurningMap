<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp ,  } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-analytics.js";
  import { getAuth, onAuthStateChanged  } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-auth.js";
  import { signInWithPopup } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-auth.js";
  import { FacebookAuthProvider } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, query, where  } from 'https://www.gstatic.com/firebasejs/10.2.0/firebase-firestore.js'


  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBSA8KMocg7ik3eNK02CV6d3C-yMNi8n0c",
    authDomain: "not-burning-map.firebaseapp.com",
    databaseURL: "https://not-burning-map-default-rtdb.firebaseio.com",
    projectId: "not-burning-map",
    storageBucket: "not-burning-map.appspot.com",
    messagingSenderId: "305640361948",
    appId: "1:305640361948:web:b29de65b90f6acf598c919",
    measurementId: "G-N3HV2F48KQ"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);

  const provider = new FacebookAuthProvider();

  const auth = getAuth();
  
  
  // Initialize Cloud Firestore and get a reference to the service
  const db = getFirestore(app);

  var map;
  var currentUser;
  var  credential;
  var accessToken;

  const loginButton = document.getElementById("loginButton");
  loginButton.style.display = "block"; // Display the button
  loginButton.addEventListener("click", () => {
      signInWithFacebook(); // Call your function to open the login popup
  });
  
  //signInWithFacebook();

  const centerButton = document.getElementById("centerButton");
  if ("geolocation" in navigator) {
      // Center Button Event Listener
      centerButton.addEventListener("click", CenterLocatoin);
  } else {
      console.error("Geolocation not supported by the browser");
  }

  CenterLocatoin();
    
  const getFriendsButton = document.getElementById("getFriendsButton");
  getFriendsButton.addEventListener("click", getFriendsList);

  async function getFriendsList(){
      const friendsList = document.getElementById("friendsList");

      // Get the authenticated user from Firebase
      //const user = firebase.auth().currentUser;
      
      if (currentUser) {
          // Get Facebook friends using Facebook Graph API
          var graphString = `https://graph.facebook.com/${currentUser.providerData[0].uid}}/friends?access_token=${currentUser.accessToken}`;
          console.log("Calling " + graphString)
          const response = await fetch(graphString);
          const data = await response.json();

          console.log("result  " + data + data.data);
          const friends = data.data;

          // Iterate through friends and check their authentication status
          const friendsSignedIn = [];
          for (const friend of friends) {
              try {
                  // Check if friend is signed in to your Firebase app
                  //const provider = new firebase.auth.FacebookAuthProvider();
                  //provider.addScope('email'); // Add necessary scopes

                  //const credential = firebase.auth.FacebookAuthProvider.credential(friend.id, user.accessToken);
                  //await firebase.auth().signInWithCredential(credential);

                  // Friend is signed in
                  friendsSignedIn.push(friend);
              } catch (error) {
                  // Friend is not signed in
              }
          }

          // Display the list of signed-in friends
          friendsList.innerHTML = friendsSignedIn.map(friend => `<li>${friend.name}</li>`).join("");
      } else {
          console.error("User is not authenticated.");
      }
      
      
  }
  
  function CenterLocatoin(){

      // Center the map on the user's location
      navigator.geolocation.getCurrentPosition(position => {
          const { latitude, longitude } = position.coords;


          const loggedInContent = document.getElementById("loggedInContent");
          loggedInContent.style.display = "block";

          const locationForm = document.getElementById("locationForm");
          locationForm.addEventListener("submit", event => {

              event.preventDefault();
              submitData("");


          });
          
          const latitudeInput = document.getElementById("latitude");
          const longitudeInput = document.getElementById("longitude");
          
          latitudeInput.value = latitude;
          longitudeInput.value = longitude;
          
          // Initialize the map centered on user's location
          map.setView([latitude, longitude], 13);


          // Add a marker for the user's location
          L.marker([latitude, longitude]).addTo(map)
              .bindPopup('Your Location')
              .openPopup();
          
          
          

      }, error => {
          console.error("Error getting user's location:", error);
      });
      
  }

  const loadEveryone = document.getElementById("loadEveryone");
  loadEveryone.addEventListener("click", LoadEveryonesLocation);


  async function LoadEveryonesLocation() {

      //const q = query(collection(db, "users"), where("userId", "==", userId));
      const q = query(collection(db, "users"));

      const querySnapshot = await getDocs(q);
      querySnapshot.forEach((doc) => {
          console.log(`doc.id = ${doc.id} => doc.data = ${doc.data()}`);

          
          const userData = doc.data();
          console.log("Found User data for" + userData.userId + " = " + userData.playaName + " " + userData);
                   
          // Add a marker for the user's location
          L.marker([ userData.latitude, userData.longitude ]).addTo(map)
              .bindPopup(userData.playaName)
              .openPopup();

      });
  }

  function signInWithFacebook() {

      signInWithPopup(auth, provider)
          .then((result) => {
              // The signed-in user info.
              const user = result.user;

              currentUser = user;
              
              // This gives you a Facebook Access Token. You can use it to access the Facebook API.
              credential = FacebookAuthProvider.credentialFromResult(result);
              accessToken = credential.accessToken;

              // IdP data available using getAdditionalUserInfo(result)
              // ...

              // FIX? move all this to to status change?
              console.log("User is logged in:", user.displayName);

              // remove login buttons
              const loginButton = document.getElementById("loginButton");
              if (loginButton) {
                  loginButton.style.display = "none";
              }
              
              LoggedIn(user);

          })
          .catch((error) => {
              // Handle Errors here.
              const errorCode = error.code;
              const errorMessage = error.message;

              console.log("Error message " + error.code + " " + error.message);
              // The email of the user's account used.
              //const email = error.customData.email;
              // The AuthCredential type that was used.
              const credential = FacebookAuthProvider.credentialFromError(error);

              // ...

              console.log("User is not logged in ");

              // Show the login button and add a click event listener
              const loginButton = document.getElementById("loginButton");
              loginButton.style.display = "block"; // Display the button
              loginButton.addEventListener("click", () => {
                  signInWithFacebook(); // Call your function to open the login popup
              });

          });
  }

  async function getUserData(userId) {

      const latitudeInput = document.getElementById("latitude");
      const longitudeInput = document.getElementById("longitude");
      const playaNameInput = document.getElementById("playaName");

      const q = query(collection(db, "users"), where("userId", "==", userId));
     
      const querySnapshot = await getDocs(q);
      querySnapshot.forEach((doc) => {
          console.log(`doc.id = ${doc.id} => doc.data = ${doc.data()}`);
     
          console.log("Found User data for" + userId)
          const userData = doc.data();
          // Populate form with user's lat/long data
          latitudeInput.value = userData.latitude || "";
          longitudeInput.value = userData.longitude || "";
          playaNameInput.value = userData.playaName || "";


          // Add a marker for the user's location
          L.marker([ userData.latitude, userData.longitude ]).addTo(map)
              .bindPopup(userData.playaName)
              .openPopup();
     
      });
  }
    function LoggedIn(user) {

        const greetingElement = document.getElementById("greeting");
        const loggedInContent = document.getElementById("loggedInContent");
        const locationForm = document.getElementById("locationForm");
        
        
        if (user) {
            // User is logged in
            console.log("User is logged in 2:", user.displayName);
            // You can show other content or features for logged-in users here
            console.log("greetingElement" + greetingElement);
            greetingElement.textContent = "Hello " + user.displayName;

            loggedInContent.style.display = "block";

            // Retrieve user's data from Firestore
            const userId = user.uid;


            console.log("Getting user data for   " + userId);
            getUserData(userId); 
       

            // Handle form submission
            locationForm.addEventListener("submit", event => {
                
                event.preventDefault();
                submitData(userId);
                
               
            });
        }

        // Check if the user is logged in
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User is logged in OnAuthStatusChange");
                //LoggedIn(user);

            } else {
                // User is not logged in
                console.log("User is not logged in OnAuthStatusChange");

                // Show the login button and add a click event listener
                const loginButton = document.getElementById("loginButton");
                loginButton.style.display = "block"; // Display the button
                loginButton.addEventListener("click", () => {
                    signInWithFacebook(); // Call your function to open the login popup
                });
            }
        });
    }

    async function submitData(userId) {

        const latitudeInput = document.getElementById("latitude");
        const longitudeInput = document.getElementById("longitude");
        const playaNameInput = document.getElementById("playaName");

        // Get new lat/long values from form
        const newLatitude = latitudeInput.value;
        const newLongitude = longitudeInput.value;

        setUserData(userId,newLatitude,newLongitude , playaNameInput.value);
    }
  async function setUserData(userId,newLatitude,newLongitude ,playaName) {


      // Add a marker for the user's location
      L.marker([newLatitude, newLongitude]).addTo(map)
          .bindPopup(playaName)
          .openPopup();
      
      try {
          const docRef = await addDoc(collection(db, "users"), {
              userId: userId,
              latitude: newLatitude,
              longitude: newLongitude,
              playaName: playaName
          });
          console.log("Location updated successfully  with ID: ", docRef.id);
      } catch (e) {
          console.error("Error adding Location: ", e);
      }

  }

  function SetupMap() {
      //const mapContainer = document.getElementById("mapContainer");

      // Initialize the map
      //const map = L.map('map').setView([0, 0], 2); // Set initial coordinates and zoom level
      // const map = L.map('mapContainer').setView([32.1415568, 34.8322442], 13); // Set initial coordinates and zoom level
      map = L.map('mapContainer').setView([40.7859569, -119.2264743], 15); // Set initial coordinates and zoom level

      // Add a tile layer (you can choose different tile providers)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      // Add markers for friends' locations
      // You would need to fetch friends' locations from Firestore and iterate through them
      // Example: Add a marker for a friend's location

      // BM is : 40.7859569,-119.2264743
      /*
  var latitude = 32.1415568;
  var longitude = 34.8322442;
  const friendLocation = [latitude, longitude]; // Replace with actual coordinates
  L.marker(friendLocation).addTo(map).bindPopup("Your friend's name");
  */
  }


  SetupMap();
</script>



<!-- 
<div id="greeting">Hello . Please log in to continue</div>

<button id="loginButton">Log In with Facebook</button>
-->

<div id="loggedInContent" style="display: none;">
    <!-- HTML Form for Lat/Long -->
    <form id="locationForm">

        <label for="playaName">Playa Name:</label>
        <input type="text" id="playaName" name="playaName" required><br>

        <label for="latitude">Latitude:</label>
        <input type="text" id="latitude" name="latitude" required><br>

        <label for="longitude">Longitude:</label>
        <input type="text" id="longitude" name="longitude" required><br>

        <button type="submit">Save</button>
    </form>
</div>

<!-- Center Button -->
<button id="centerButton">Center on My Location</button>
<button id="loadEveryone">Load Everyone's Locations</button>

<!--
<button id="getFriendsButton">Get Facebook Friends Location</button>
-->


<!-- Create a map container -->
map:
<div id="map"></div>
<div id="mapContainer"></div>
<style>
    #mapContainer {
        height: 500px;
    }
</style>


<ul id="friendsList"></ul>


<!-- Add the Leaflet CSS and JavaScript links -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>


<script>
    
   
     
</script>

