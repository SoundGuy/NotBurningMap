<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp ,  } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-analytics.js";
  import { getAuth, onAuthStateChanged  } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-auth.js";
  import { signInWithPopup } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-auth.js";
  import { FacebookAuthProvider } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.2.0/firebase-firestore.js'


  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBSA8KMocg7ik3eNK02CV6d3C-yMNi8n0c",
    authDomain: "not-burning-map.firebaseapp.com",
    databaseURL: "https://not-burning-map-default-rtdb.firebaseio.com",
    projectId: "not-burning-map",
    storageBucket: "not-burning-map.appspot.com",
    messagingSenderId: "305640361948",
    appId: "1:305640361948:web:b29de65b90f6acf598c919",
    measurementId: "G-N3HV2F48KQ"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);

  const provider = new FacebookAuthProvider();

  const auth = getAuth();
  
  
  // Initialize Cloud Firestore and get a reference to the service
  const db = getFirestore(app);


  const loginButton = document.getElementById("loginButton");
  loginButton.style.display = "block"; // Display the button
  loginButton.addEventListener("click", () => {
      signInWithFacebook(); // Call your function to open the login popup
  });
  
  //signInWithFacebook();

  
  function signInWithFacebook() {

      signInWithPopup(auth, provider)
          .then((result) => {
              // The signed-in user info.
              const user = result.user;

              // This gives you a Facebook Access Token. You can use it to access the Facebook API.
              const credential = FacebookAuthProvider.credentialFromResult(result);
              const accessToken = credential.accessToken;

              // IdP data available using getAdditionalUserInfo(result)
              // ...

              // FIX? move all this to to status change?
              console.log("User is logged in:", user.displayName);

              // remove login buttons
              const loginButton = document.getElementById("loginButton");
              if (loginButton) {
                  loginButton.style.display = "none";
              }
              
              LoggedIn(user);

          })
          .catch((error) => {
              // Handle Errors here.
              const errorCode = error.code;
              const errorMessage = error.message;

              console.log("Error message " + error.code + " " + error.message);
              // The email of the user's account used.
              //const email = error.customData.email;
              // The AuthCredential type that was used.
              const credential = FacebookAuthProvider.credentialFromError(error);

              // ...

              console.log("User is not logged in ");

              // Show the login button and add a click event listener
              const loginButton = document.getElementById("loginButton");
              loginButton.style.display = "block"; // Display the button
              loginButton.addEventListener("click", () => {
                  signInWithFacebook(); // Call your function to open the login popup
              });

          });
  }

  async function getUserData(userId) {

      const querySnapshot = await getDocs(collection(db, "users"));
      querySnapshot.forEach((doc) => {
          console.log(`${doc.id} => ${doc.data()}`);
          if (doc.id == userId) {
              console.log("Found User data for" + userId)
              const userData = doc.data();
              // Populate form with user's lat/long data
              latitudeInput.value = userData.latitude || "";
              longitudeInput.value = userData.longitude || "";
          }
      });
  }
    function LoggedIn(user) {

        const greetingElement = document.getElementById("greeting");
        const loggedInContent = document.getElementById("loggedInContent");
        const locationForm = document.getElementById("locationForm");
        const latitudeInput = document.getElementById("latitude");
        const longitudeInput = document.getElementById("longitude");
        
        if (user) {
            // User is logged in
            console.log("User is logged in 2:", user.displayName);
            // You can show other content or features for logged-in users here
            console.log("greetingElement" + greetingElement);
            greetingElement.textContent = "Hello " + user.displayName;

            loggedInContent.style.display = "block";

            // Retrieve user's data from Firestore
            const userId = user.uid;


            console.log("Getting user data for   " + user.uid);
            getUserData(user.uid); 
        /*    const userDocRef = db.collection("users").doc(userId);
            
            userDocRef.get().then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    // Populate form with user's lat/long data
                    latitudeInput.value = userData.latitude || "";
                    longitudeInput.value = userData.longitude || "";
                }
            });*/

            // Handle form submission
            locationForm.addEventListener("submit", event => {
                event.preventDefault();

                // Get new lat/long values from form
                const newLatitude = latitudeInput.value;
                const newLongitude = longitudeInput.value;

                // Update user's lat/long in Firestore
                userDocRef.update({
                    latitude: newLatitude,
                    longitude: newLongitude
                }).then(() => {
                    console.log("Location updated successfully");
                }).catch(error => {
                    console.error("Error updating location:", error);
                });
            });
        }

        // Check if the user is logged in
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User is logged in OnAuthStatusChange");
                //LoggedIn(user);

            } else {
                // User is not logged in
                console.log("User is not logged in OnAuthStatusChange");

                // Show the login button and add a click event listener
                const loginButton = document.getElementById("loginButton");
                loginButton.style.display = "block"; // Display the button
                loginButton.addEventListener("click", () => {
                    signInWithFacebook(); // Call your function to open the login popup
                });
            }
        });
    }

</script>



<div id="greeting">Hello . Please log in to continue</div>

<button id="loginButton">Log In with Facebook</button>

<div id="loggedInContent" style="display: none;">
    <!-- HTML Form for Lat/Long -->
    <form id="locationForm">
        <label for="latitude">Latitude:</label>
        <input type="text" id="latitude" name="latitude" required><br>

        <label for="longitude">Longitude:</label>
        <input type="text" id="longitude" name="longitude" required><br>

        <button type="submit">Save</button>
    </form>
</div>


<!-- Create a map container -->
map:
<div id="map"></div>


<!-- Add the Leaflet CSS and JavaScript links -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>


<script>
    // Initialize the map
    const map = L.map('map').setView([0, 0], 2); // Set initial coordinates and zoom level

    // Add a tile layer (you can choose different tile providers)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Add markers for friends' locations
    // You would need to fetch friends' locations from Firestore and iterate through them
    // Example: Add a marker for a friend's location

    var latitude = 32.1415568;
    var longitude = 34.8322442;
    const friendLocation = [latitude, longitude]; // Replace with actual coordinates
    L.marker(friendLocation).addTo(map).bindPopup("Your friend's name");
</script>
